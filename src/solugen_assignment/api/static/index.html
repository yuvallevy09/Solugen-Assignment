<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BBC Politics Context Retriever</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: #111b2e;
        --text: #e6edf7;
        --muted: #a8b3c7;
        --border: rgba(255, 255, 255, 0.12);
        --accent: #7aa2ff;
        --danger: #ff6b6b;
        --good: #2bd576;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(1200px 600px at 30% 10%, #132145, var(--bg));
        color: var(--text);
      }
      .wrap {
        max-width: 980px;
        margin: 40px auto;
        padding: 0 16px;
      }
      .card {
        background: rgba(17, 27, 46, 0.92);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.4);
      }
      .titleRow {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
      }
      h1 {
        margin: 0 0 6px;
        font-size: 22px;
        letter-spacing: 0.2px;
      }
      p {
        margin: 0 0 14px;
        color: var(--muted);
        line-height: 1.4;
      }
      .tag {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.24);
      }
      .dot.good {
        background: rgba(43, 213, 118, 0.8);
      }
      .dot.warn {
        background: rgba(255, 196, 61, 0.85);
      }
      .dot.bad {
        background: rgba(255, 107, 107, 0.85);
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 120px 180px 120px;
        gap: 10px;
        align-items: end;
      }
      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin: 0 0 6px;
      }
      input {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(11, 18, 32, 0.55);
        color: var(--text);
        outline: none;
      }
      input:focus {
        border-color: rgba(122, 162, 255, 0.55);
        box-shadow: 0 0 0 3px rgba(122, 162, 255, 0.18);
      }
      button {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(122, 162, 255, 0.45);
        background: rgba(122, 162, 255, 0.18);
        color: var(--text);
        cursor: pointer;
      }
      button:hover {
        background: rgba(122, 162, 255, 0.26);
      }
      .secondaryBtn {
        border-color: rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
      }
      .secondaryBtn:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .meta {
        margin-top: 12px;
        display: flex;
        gap: 12px;
        align-items: center;
        color: var(--muted);
        font-size: 12px;
      }
      .error {
        color: var(--danger);
        margin-top: 10px;
        font-size: 13px;
        white-space: pre-wrap;
      }
      .results {
        margin-top: 16px;
        display: grid;
        gap: 12px;
      }
      .helpGrid {
        margin-top: 14px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .helpCard {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: rgba(11, 18, 32, 0.25);
      }
      .helpTitle {
        margin: 0 0 8px;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.2px;
        text-transform: uppercase;
      }
      .exampleList {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chipBtn {
        width: auto;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
        font-size: 12px;
        cursor: pointer;
      }
      .chipBtn:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
        font-size: 12px;
        color: rgba(230, 237, 247, 0.88);
      }
      .result {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: rgba(11, 18, 32, 0.35);
      }
      .resultHeader {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 14px;
        align-items: baseline;
        margin-bottom: 8px;
      }
      .pill {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        font-size: 12px;
        color: var(--muted);
      }
      .pill strong {
        color: var(--text);
        font-weight: 600;
      }
      pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.45;
        font-size: 13px;
        color: rgba(230, 237, 247, 0.92);
      }
      .footerNote {
        margin-top: 12px;
        font-size: 12px;
        color: var(--muted);
      }
      @media (max-width: 840px) {
        .row {
          grid-template-columns: 1fr 1fr;
        }
        .helpGrid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="titleRow">
          <div>
            <h1>BBC Politics Context Retriever</h1>
            <p>
              Search a curated set of <strong>13</strong> BBC politics articles. This page shows retrieved
              chunks + similarity scores (retrieval only).
            </p>
          </div>
          <div class="tag" title="Build embeddings once, then search">
            <span id="uiDot" class="dot warn"></span>
            <span id="uiTagText">Index not built</span>
          </div>
        </div>
        <p>
          Not sure what to ask? Use one of the examples below, or start with a person/topic
          (e.g. “Patricia Hewitt”, “Freedom of Information”, “super-casino”, “Budget giveaway”).
        </p>

        <div class="row" style="margin-bottom: 10px">
          <div style="grid-column: 1 / -1">
            <button id="buildBtn" type="button">Build / Rebuild Index (embeddings)</button>
          </div>
        </div>

        <div id="indexInfo" class="meta" style="margin-top: 0">
          <span>Index: <span id="indexStatus">unknown</span></span>
          <span>Chunks: <span id="indexCount">0</span></span>
          <span>Model: <span id="indexModel">—</span></span>
        </div>
        <div id="embeddingInfo" class="meta" style="display: none">
          <span>Sample embedding dim: <span id="embDim">—</span></span>
          <span>norm: <span id="embNorm">—</span></span>
          <span>head: <span id="embHead">—</span></span>
        </div>

        <form id="searchForm" style="margin-top: 10px">
          <div class="row">
            <div>
              <label for="query">Query</label>
              <input id="query" name="query" placeholder="Try: How much was maternity pay proposed to rise by?" required />
            </div>
            <div>
              <label for="topK">Top‑K</label>
              <input id="topK" name="topK" type="number" min="1" max="20" value="5" />
            </div>
            <div>
              <label for="threshold">Similarity threshold (optional)</label>
              <input
                id="threshold"
                name="threshold"
                type="number"
                step="0.01"
                min="-1"
                max="1"
                placeholder="e.g. 0.20"
              />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="btn" type="submit">Search</button>
            </div>
          </div>
        </form>

        <div class="helpGrid">
          <div class="helpCard">
            <div class="helpTitle">Try asking</div>
            <div id="examples" class="exampleList"></div>
          </div>
          <div class="helpCard">
            <div class="helpTitle">Tips</div>
            <div class="mono">
              - Build the index once, then search<br />
              - Use names, parties, places, or specific events<br />
              - If you get no matches, lower the similarity threshold (or clear it)
            </div>
            <div style="margin-top: 10px">
              <button id="clearBtn" class="secondaryBtn" type="button">Clear results</button>
            </div>
          </div>
        </div>

        <div class="meta">
          <span id="status">Ready.</span>
        </div>
        <div id="error" class="error" style="display: none"></div>

        <div id="results" class="results"></div>

        <div class="footerNote">
          Flow: click “Build / Rebuild Index” once (stores embeddings), then run searches. Search will
          error if the index hasn’t been built yet.
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("searchForm");
      const buildBtn = document.getElementById("buildBtn");
      const queryEl = document.getElementById("query");
      const topKEl = document.getElementById("topK");
      const thresholdEl = document.getElementById("threshold");
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const resultsEl = document.getElementById("results");
      const btn = document.getElementById("btn");
      const clearBtn = document.getElementById("clearBtn");
      const examplesEl = document.getElementById("examples");
      const uiDotEl = document.getElementById("uiDot");
      const uiTagTextEl = document.getElementById("uiTagText");
      const indexStatusEl = document.getElementById("indexStatus");
      const indexCountEl = document.getElementById("indexCount");
      const indexModelEl = document.getElementById("indexModel");
      const embeddingInfoEl = document.getElementById("embeddingInfo");
      const embDimEl = document.getElementById("embDim");
      const embNormEl = document.getElementById("embNorm");
      const embHeadEl = document.getElementById("embHead");

      // If you open this HTML directly (file://), relative fetch("/...") won't reach your API.
      // In that case, we fall back to a sensible local default.
      const API_BASE =
        window.location.protocol === "file:" ? "http://127.0.0.1:8001" : "";

      async function apiFetch(path, opts) {
        return await fetch(`${API_BASE}${path}`, opts);
      }

      const EXAMPLES = [
        "How much was maternity pay proposed to rise by?",
        "What did Patricia Hewitt propose about maternity leave?",
        "What were the Cabinet Office e-mail deletion rules about?",
        "What did Richard Thomas say about destroying records?",
        "What did Ed Balls say about a pre-election Budget giveaway?",
        "What went wrong with the first Millennium Dome sale attempt?",
        "What did the study find about sexist taunts toward women MPs?",
        "What did Tony Blair say about holding an election TV debate?",
        "What was the issue with Scottish super-casinos and Westminster?",
      ];

      function renderExamples() {
        examplesEl.innerHTML = EXAMPLES.map(
          (q) => `<button type="button" class="chipBtn" data-q="${escapeHtml(q)}">${escapeHtml(q)}</button>`
        ).join("");

        examplesEl.querySelectorAll("button[data-q]").forEach((b) => {
          b.addEventListener("click", () => {
            const q = b.getAttribute("data-q") || "";
            queryEl.value = q;
            queryEl.focus();
          });
        });
      }

      // Simple progress UI injected below index info
      const progressWrap = document.createElement("div");
      progressWrap.className = "meta";
      progressWrap.style.marginTop = "8px";
      progressWrap.innerHTML = `
        <span>Progress: <span id="progMsg">—</span></span>
        <span style="flex:1"></span>
        <span><span id="progPct">0</span>%</span>
      `;
      const barOuter = document.createElement("div");
      barOuter.style.height = "8px";
      barOuter.style.border = "1px solid rgba(255,255,255,0.12)";
      barOuter.style.borderRadius = "999px";
      barOuter.style.overflow = "hidden";
      barOuter.style.marginTop = "6px";
      const barInner = document.createElement("div");
      barInner.style.height = "100%";
      barInner.style.width = "0%";
      barInner.style.background = "rgba(122,162,255,0.55)";
      barOuter.appendChild(barInner);
      const indexInfo = document.getElementById("indexInfo");
      indexInfo.parentNode.insertBefore(progressWrap, indexInfo.nextSibling);
      indexInfo.parentNode.insertBefore(barOuter, progressWrap.nextSibling);
      const progMsgEl = progressWrap.querySelector("#progMsg");
      const progPctEl = progressWrap.querySelector("#progPct");

      function setError(msg) {
        if (!msg) {
          errorEl.style.display = "none";
          errorEl.textContent = "";
          return;
        }
        errorEl.style.display = "block";
        errorEl.textContent = msg;
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderResults(results) {
        resultsEl.innerHTML = "";
        if (!results || results.length === 0) {
          resultsEl.innerHTML = `<div class="result"><div class="pill"><strong>No matches</strong></div></div>`;
          return;
        }
        const parts = results.map((r) => {
          const score = typeof r.score === "number" ? r.score.toFixed(3) : String(r.score);
          const chunkId = r.chunk_id ?? "";
          const docId = r.doc_id ?? "";
          const category = r.category ?? "";
          const kind = r.kind ?? "";
          const startChar = r.start_char ?? null;
          const endChar = r.end_char ?? null;
          const range =
            startChar !== null && endChar !== null ? `${startChar}-${endChar}` : "n/a";
          const text = r.text ?? "";
          return `
            <div class="result">
              <div class="resultHeader">
                <span class="pill"><strong>chunk_id</strong> ${escapeHtml(chunkId)}</span>
                <span class="pill"><strong>score</strong> ${escapeHtml(score)}</span>
                <span class="pill"><strong>doc_id</strong> ${escapeHtml(docId)}</span>
                <span class="pill"><strong>category</strong> ${escapeHtml(category)}</span>
                <span class="pill"><strong>kind</strong> ${escapeHtml(kind)}</span>
                <span class="pill"><strong>char_range</strong> ${escapeHtml(range)}</span>
              </div>
              <pre>${escapeHtml(text)}</pre>
            </div>
          `;
        });
        resultsEl.innerHTML = parts.join("\n");
      }

      async function refreshIndexStatus() {
        try {
          const resp = await apiFetch("/index/status");
          const data = await resp.json().catch(() => null);
          if (!resp.ok) throw new Error((data && data.detail) || `HTTP ${resp.status}`);
          indexStatusEl.textContent = data.built ? "built" : "not built";
          indexCountEl.textContent = String(data.count ?? 0);
          const model = data?.desired_meta?.embedding_model || data?.existing_meta?.embedding_model || "—";
          indexModelEl.textContent = model;
          if (data.built) {
            uiDotEl.className = "dot good";
            uiTagTextEl.textContent = "Index built";
          } else {
            uiDotEl.className = "dot warn";
            uiTagTextEl.textContent = "Index not built";
          }
          return data;
        } catch {
          indexStatusEl.textContent = "error";
          indexCountEl.textContent = "0";
          indexModelEl.textContent = "—";
          uiDotEl.className = "dot bad";
          uiTagTextEl.textContent = "Index status error";
          return null;
        }
      }

      async function refreshEmbeddingSample() {
        try {
          const resp = await apiFetch("/index/sample?limit=1");
          // 409 means "index not built yet" (expected before you build embeddings).
          if (resp.status === 409) {
            embeddingInfoEl.style.display = "none";
            return;
          }
          const data = await resp.json().catch(() => null);
          if (!resp.ok) throw new Error((data && data.detail) || `HTTP ${resp.status}`);
          const s = (data.samples || [])[0];
          if (!s) {
            embeddingInfoEl.style.display = "none";
            return;
          }
          embeddingInfoEl.style.display = "flex";
          embDimEl.textContent = String(s.embedding_dim ?? "—");
          embNormEl.textContent = typeof s.embedding_norm === "number" ? s.embedding_norm.toFixed(3) : String(s.embedding_norm ?? "—");
          embHeadEl.textContent = Array.isArray(s.embedding_head) ? s.embedding_head.map((x) => Number(x).toFixed(3)).join(", ") : "—";
        } catch {
          embeddingInfoEl.style.display = "none";
        }
      }

      async function fetchProgress() {
        const resp = await apiFetch("/index/progress");
        const data = await resp.json().catch(() => null);
        if (!resp.ok) {
          const detail = data && data.detail ? data.detail : `HTTP ${resp.status}`;
          throw new Error(String(detail));
        }
        return data;
      }

      function computePct(p) {
        // Prefer chunks embedded progress once we know total chunks; otherwise use doc progress.
        if (p && p.chunks_total && p.chunks_total > 0) {
          return Math.max(0, Math.min(100, Math.round((100 * (p.chunks_embedded || 0)) / p.chunks_total)));
        }
        if (p && p.docs_total && p.docs_total > 0) {
          return Math.max(0, Math.min(100, Math.round((100 * (p.docs_done || 0)) / p.docs_total)));
        }
        return 0;
      }

      function renderProgress(p) {
        const msg = p && p.message ? p.message : (p && p.stage ? p.stage : "—");
        progMsgEl.textContent = msg;
        const pct = computePct(p);
        progPctEl.textContent = String(pct);
        barInner.style.width = `${pct}%`;
      }

      buildBtn.addEventListener("click", async () => {
        setError("");
        resultsEl.innerHTML = "";
        statusEl.textContent = "Building index…";
        buildBtn.disabled = true;
        btn.disabled = true;
        uiDotEl.className = "dot warn";
        uiTagTextEl.textContent = "Building…";
        try {
          // Kick off build request and poll progress, but surface failures immediately.
          // (Previously, a fast failure could look like "nothing happens" until polling timed out.)
          const buildPromise = (async () => {
            const resp = await apiFetch("/index/build", { method: "POST" });
            const data = await resp.json().catch(() => null);
            if (!resp.ok) {
              const detail = data && data.detail ? data.detail : `HTTP ${resp.status}`;
              throw new Error(String(detail));
            }
            return data;
          })();

          const startedAt = Date.now();
          while (true) {
            const race = await Promise.race([
              buildPromise.then((data) => ({ kind: "done", data })),
              new Promise((r) => setTimeout(() => r({ kind: "tick" }), 400)),
            ]);

            if (race.kind === "done") {
              const data = race.data;
              await refreshIndexStatus();
              await refreshEmbeddingSample();
              renderProgress({
                stage: "done",
                message: "index built",
                done: true,
                chunks_total: data.count || 0,
                chunks_embedded: data.count || 0,
              });
              statusEl.textContent = `Index built. Chunks: ${data.count ?? "?"}`;
              break;
            }

            try {
              const p = await fetchProgress();
              renderProgress(p);
              if (p && p.error) throw new Error(String(p.error));
            } catch {
              // ignore transient progress errors; buildPromise will surface real failures immediately
            }

            // safety: stop polling after 10 minutes
            if (Date.now() - startedAt > 10 * 60 * 1000) {
              throw new Error("Timed out waiting for index build (10 minutes). Check server logs.");
            }
          }
        } catch (err) {
          statusEl.textContent = "Error.";
          setError(err && err.message ? err.message : String(err));
          uiDotEl.className = "dot bad";
          uiTagTextEl.textContent = "Build failed";
        } finally {
          buildBtn.disabled = false;
          btn.disabled = false;
        }
      });

      clearBtn.addEventListener("click", () => {
        setError("");
        resultsEl.innerHTML = "";
        statusEl.textContent = "Cleared.";
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setError("");
        resultsEl.innerHTML = "";

        const query = (queryEl.value || "").trim();
        if (!query) {
          setError("Query is required.");
          return;
        }
        const top_k = Number(topKEl.value || 5);
        const thresholdRaw = (thresholdEl.value || "").trim();
        const similarity_threshold = thresholdRaw === "" ? null : Number(thresholdRaw);

        statusEl.textContent = "Searching…";
        btn.disabled = true;
        buildBtn.disabled = true;

        try {
          const body = { query, top_k };
          if (similarity_threshold !== null && !Number.isNaN(similarity_threshold)) {
            body.similarity_threshold = similarity_threshold;
          }
          const resp = await apiFetch("/search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const data = await resp.json().catch(() => null);
          if (!resp.ok) {
            const detail = data && data.detail ? data.detail : `HTTP ${resp.status}`;
            throw new Error(String(detail));
          }

          renderResults(data.results || []);
          statusEl.textContent = `Done. Results: ${(data.results || []).length}`;
        } catch (err) {
          statusEl.textContent = "Error.";
          setError(err && err.message ? err.message : String(err));
        } finally {
          btn.disabled = false;
          buildBtn.disabled = false;
        }
      });

      // Initial load
      renderExamples();
      refreshIndexStatus().then((st) => {
        if (st && st.built) return refreshEmbeddingSample();
        embeddingInfoEl.style.display = "none";
      });
      fetchProgress().then((p) => renderProgress(p)).catch(() => {});
    </script>
  </body>
</html>

